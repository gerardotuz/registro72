<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Selecci√≥n de Paraescolar</title>
<link rel="stylesheet" href="/style.css">

<style>
body {
  font-family: Arial, sans-serif;
}

.container {
  max-width: 700px;
  margin: auto;
  padding: 20px;
}

input, select, button {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
}

fieldset {
  margin-top: 15px;
}

.locked {
  background-color: #eee;
}
</style>
</head>

<body>
<nav>
<div class="nav-logo">
<img alt="Logo" src="/logo.png"/>
</div>
<div class="nav-links">
<a href="index.html">Inicio</a>
<a href="consultar-grupo.html">Consultar grupo</a>

<a href="login.html">Iniciar sesi√≥n</a>
</div>
</nav>
<div class="container">

<h2>Registro de Paraescolar</h2>

<form id="registroForm">

<!-- üîç BUSCADOR -->
<div>
  <input type="text" id="numero_control" placeholder="Ingresa tu N√∫mero de Control" required>
  <button type="button" onclick="buscarAlumno()">Buscar</button>
</div>

<!-- üìã DATOS DEL ALUMNO -->
<fieldset>
  <legend>Datos del Alumno</legend>

  <input id="curp" placeholder="CURP" readonly>
  <input id="nombre" placeholder="Nombre Completo" readonly>
  <input id="grado" placeholder="Grado" readonly>
  <input id="grupo" placeholder="Grupo" readonly>

</fieldset>

<!-- üéØ PARAESCOLAR -->
<fieldset>
  <legend>Selecciona Paraescolar</legend>

  <select id="paraescolar" required disabled>
    <option value="">-- Selecciona --</option>
  </select>

</fieldset>

<button type="submit">Guardar Paraescolar</button>

</form>

</div>

<script>
let alumno = null;
let guardando = false;

// üîç Buscar alumno
async function buscarAlumno() {
  const controlInput = document.getElementById("numero_control");
  const control = controlInput.value.trim();

  if (!control) {
    alert("‚ö†Ô∏è Ingresa tu n√∫mero de control.");
    controlInput.focus();
    return;
  }

  if (!/^[0-9]{8,20}$/.test(control)) {
    alert("‚ö†Ô∏è El n√∫mero de control debe ser num√©rico.");
    return;
  }

  try {
    const resp = await fetch(`/api/paraescolar/${control}`);
    const data = await resp.json();

    if (data.error) {
      alert("‚ùå Alumno no encontrado.");
      limpiarFormulario();
      return;
    }

    alumno = data;

    curp.value   = data.curp || "";
    nombre.value = data.nombre || "";
    grado.value  = data.grado || "";
    grupo.value  = data.grupo || "";

    await cargarCupos();   // üî• cargar cupos din√°micos

    if (data.bloqueado) {
      paraescolar.value = data.paraescolar;
      paraescolar.disabled = true;
      alert("‚úÖ Ya tienes un paraescolar asignado.");
    } else {
      paraescolar.disabled = false;
    }

  } catch (error) {
    console.error(error);
    alert("‚ùå Error de conexi√≥n con el servidor.");
  }
}

// üíæ Guardar selecci√≥n
document.getElementById("registroForm").addEventListener("submit", async e => {
  e.preventDefault();

  if (!alumno) return alert("‚ö†Ô∏è Primero busca tu n√∫mero de control.");
  if (!paraescolar.value) return alert("‚ö†Ô∏è Selecciona un paraescolar.");

  if (guardando) return;
  guardando = true;

  try {
    const resp = await fetch(`/api/paraescolar/${alumno._id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ paraescolar: paraescolar.value })
    });

    const result = await resp.json();

    if (result.error) {
      alert("‚ùå " + result.error);
    } else {
      alert("üéâ Paraescolar registrado correctamente.");
      paraescolar.disabled = true;
    }

  } catch (error) {
    console.error(error);
    alert("‚ùå Error al guardar.");
  } finally {
    guardando = false;
  }
});

// üßπ Limpiar
function limpiarFormulario() {
  alumno = null;
  curp.value = "";
  nombre.value = "";
  grado.value = "";
  grupo.value = "";
  paraescolar.value = "";
  paraescolar.disabled = true;
}

// üéØ Cargar cupos din√°micos
async function cargarCupos() {
  try {
    const resp = await fetch("/api/paraescolar/cupos");
    const cupos = await resp.json();

    const select = document.getElementById("paraescolar");
    select.innerHTML = `<option value="">-- SELECCIONA --</option>`;

    const lista = [
  "AJEDREZ",
  "ATLETISMO",
  "BANDA DE GUERRA",
  "BASQUETBOL",
  "DANZA",
  "ESCOLTA DE BANDERA",
  "FOTOGRAF√çA",
  "FUTBOL",
  "PINTURA",
  "TEATRO-CANTO",
  "TOCHO BANDERA",
  "VOLEIBOL",
  "ORATORIA Y DECLAMACI√ìN",
  "M√öSICA"
];


    lista.forEach(nombre => {
      const disponibles = cupos[nombre] ?? 50;

      const option = document.createElement("option");
      option.value = nombre;

      if (disponibles <= 0) {
        option.disabled = true;
        option.textContent = `${nombre} (CUPO LLENO)`;
      } else {
        option.textContent = `${nombre} (${disponibles} disponibles)`;
      }

      select.appendChild(option);
    });

  } catch (error) {
    console.error("Error cargando cupos:", error);
  }
}
</script>

</body>
</html>
