<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro Nuevo Alumno</title>

<link rel="stylesheet" href="/style.css">

<style>
.container{max-width:1000px;margin:40px auto}
.row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px}

.sin-icono:valid,
.sin-icono:invalid{
  background-image:none!important;
  padding-right:12px!important;
}
</style>
</head>

<body>

<nav>
  <div class="nav-logo"><img src="/logo.png"></div>
  <div class="nav-links">
    <a href="index.html">Inicio</a>
  </div>
</nav>

<div class="container">

<h2>üìù Registro Nuevo Alumno</h2>

<form id="formRegistro">

<!-- CURP -->
<fieldset>
<legend>Validaci√≥n por CURP</legend>

<div class="row">
  <input id="curp" class="sin-icono" maxlength="18" placeholder="CURP" required>
  <button type="button" id="btnCurp">Validar CURP</button>
</div>

<div class="row-3">
  <input id="fecha_nacimiento" readonly>
  <input id="edad" readonly>
  <input id="sexo" readonly>
</div>
</fieldset>


<!-- DATOS -->
<fieldset>
<legend>Datos Personales</legend>

<div class="row-3">
  <input id="nombres" placeholder="Nombres" required>
  <input id="apellido1" placeholder="Primer apellido" required>
  <input id="apellido2" placeholder="Segundo apellido" required>
</div>

<div class="row-3">
  <select id="estado"></select>
  <select id="municipio" disabled></select>
  <select id="ciudad" disabled></select>
</div>
</fieldset>


<!-- PARAESCOLAR -->
<fieldset>
<legend>Selecciona Paraescolar</legend>
<select id="paraescolar" required>
  <option>Cargando cupos...</option>
</select>
</fieldset>

<button type="submit">Guardar Registro</button>
<div id="resultadoRegistro" style="margin-top:20px;font-weight:bold;"></div>

</form>
</div>



<!-- ================= SCRIPT √öNICO LIMPIO ================= -->
<script>

const form = document.getElementById("formRegistro");

const curp = document.getElementById("curp");
const fecha = document.getElementById("fecha_nacimiento");
const edad = document.getElementById("edad");
const sexo = document.getElementById("sexo");

const nombres = document.getElementById("nombres");
const apellido1 = document.getElementById("apellido1");
const apellido2 = document.getElementById("apellido2");

const estado = document.getElementById("estado");
const municipio = document.getElementById("municipio");
const ciudad = document.getElementById("ciudad");

const paraescolar = document.getElementById("paraescolar");
const resultado = document.getElementById("resultadoRegistro");


/* ================= CURP ================= */

curp.addEventListener("input",()=>curp.value=curp.value.toUpperCase());

document.getElementById("btnCurp").onclick = ()=>{

  const c = curp.value;

  const regex=/^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[A-Z0-9]{2}$/;

  if(!regex.test(c)) return alert("CURP inv√°lida");

  const y=c.substring(4,6);
  const m=c.substring(6,8);
  const d=c.substring(8,10);

  const full=(y<=new Date().getFullYear()%100?"20":"19")+y;

  fecha.value=`${full}-${m}-${d}`;
  edad.value=new Date().getFullYear()-full;
  sexo.value=c[10]==="H"?"Masculino":"Femenino";

  autocompletarEstado(c);
};


/* ================= CUPOS ================= */

async function cargarCupos(){
  const resp=await fetch("/api/paraescolar/cupos");
  const cupos=await resp.json();

  const lista=["AJEDREZ","ATLETISMO","DANZA","FUTBOL","PINTURA"];

  paraescolar.innerHTML="<option>Selecciona</option>";

  lista.forEach(p=>{
    const op=new Option(`${p} (${cupos[p]??50} disponibles)`,p);
    paraescolar.appendChild(op);
  });
}
cargarCupos();


/* ================= ESTADOS ================= */

fetch("/catalogo.json")
.then(r=>r.json())
.then(data=>{
  estado.innerHTML="<option>Estado</option>";
  data.forEach(e=>estado.appendChild(new Option(e.nombre,e.nombre)));
});

function autocompletarEstado(curp){

  const estadosCURP = {
    AS:"AGUASCALIENTES", BC:"BAJA CALIFORNIA", BS:"BAJA CALIFORNIA SUR",
    CC:"CAMPECHE", CL:"COAHUILA", CM:"COLIMA", CS:"CHIAPAS", CH:"CHIHUAHUA",
    DF:"CIUDAD DE MEXICO", DG:"DURANGO", GT:"GUANAJUATO", GR:"GUERRERO",
    HG:"HIDALGO", JC:"JALISCO", MC:"MEXICO", MN:"MICHOACAN", MS:"MORELOS",
    NT:"NAYARIT", NL:"NUEVO LEON", OC:"OAXACA", PL:"PUEBLA", QT:"QUERETARO",
    QR:"QUINTANA ROO", SP:"SAN LUIS POTOSI", SL:"SINALOA", SR:"SONORA",
    TC:"TABASCO", TS:"TAMAULIPAS", TL:"TLAXCALA", VZ:"VERACRUZ",
    YN:"YUCATAN", ZS:"ZACATECAS"
  };

  const clave = curp.substring(11,13);

  if(estadosCURP[clave]){
    estado.value = estadosCURP[clave];
  }
}

/* ================= GUARDAR ================= */

form.addEventListener("submit", async e => {
  e.preventDefault();

  const payload = {
    folio: Date.now().toString(),

    datos_alumno: {
      curp: curp.value,
      nombres: nombres.value,
      primer_apellido: apellido1.value,
      segundo_apellido: apellido2.value,
      sexo: sexo.value,
      fecha_nacimiento: fecha.value,
      edad: edad.value
    },

    datos_generales: {
      paraescolar: paraescolar.value,
      correo_alumno: "temp@registro.com"
    }
  };

  try {

    const resp = await fetch("/api/guardar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await resp.json();

    // üî¥ SI ERROR DEL BACKEND
    if (!resp.ok) {
      resultado.innerHTML = `‚ùå ${result.message || "Error al guardar"}`;
      return;
    }

    // ‚úÖ √âXITO
    resultado.innerHTML = `
      ‚úÖ Registro completado <br>
      üéì N√∫mero de control: <b>${result.numero_control}</b>
    `;

    // bloquear formulario
    form.querySelectorAll("input,select,button").forEach(i => i.disabled = true);

    // abrir PDF
    if (result.pdf_url) window.open(result.pdf_url, "_blank");

  } catch (err) {
    resultado.innerHTML = "‚ùå Error del servidor";
    console.error(err);
  }
});



</script>

</body>
</html>
